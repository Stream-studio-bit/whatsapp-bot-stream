import makeWASocket, { 
  DisconnectReason, 
  fetchLatestBaileysVersion,
  BufferJSON,
  initAuthCreds,
  proto
} from '@whiskeysockets/baileys';
import { MongoClient } from 'mongodb';
import pino from 'pino';
import qrcode from 'qrcode-terminal';
import { Boom } from '@hapi/boom';
import dotenv from 'dotenv';
import readline from 'readline';
import keepAlive from './keep-alive.js';
import { startServer } from './server.js';

// Importa configura√ß√µes e servi√ßos
import { validateGroqConfig } from './config/groq.js';
import { log } from './utils/helpers.js';
import { printStats } from './services/database.js';
import { processMessage } from './controllers/messageHandler.js';
import { handleCommand, handleOwnerMessage, showStats, listBlockedUsers, listAllUsers } from './controllers/commandHandler.js';

dotenv.config();

/**
 * CONFIGURA√á√ïES GLOBAIS
 */
const MONGODB_URI = process.env.MONGODB_URI;
const SESSION_ID = process.env.SESSION_ID || 'stream-studio-bot';
const BOT_NAME = process.env.BOT_NAME || 'Assistente Stream Studio';
const OWNER_NAME = process.env.OWNER_NAME || 'Roberto';

/**
 * BANNER INICIAL
 */
function showBanner() {
  console.clear();
  console.log('\x1b[36m%s\x1b[0m', '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('\x1b[36m%s\x1b[0m', '‚ïë                                                              ‚ïë');
  console.log('\x1b[36m%s\x1b[0m', '‚ïë           ü§ñ  CHAT BOT WHATSAPP - STREAM STUDIO  ü§ñ          ‚ïë');
  console.log('\x1b[36m%s\x1b[0m', '‚ïë                                                              ‚ïë');
  console.log('\x1b[36m%s\x1b[0m', '‚ïë                    Bot Multi-tarefas com IA                  ‚ïë');
  console.log('\x1b[36m%s\x1b[0m', '‚ïë                                                              ‚ïë');
  console.log('\x1b[36m%s\x1b[0m', '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  console.log('');
  console.log('\x1b[33m%s\x1b[0m', `üì± Bot Name: ${BOT_NAME}`);
  console.log('\x1b[33m%s\x1b[0m', `üë§ Owner: ${OWNER_NAME}`);
  console.log('\x1b[33m%s\x1b[0m', `‚öôÔ∏è  Powered by: Baileys + Groq AI + MongoDB`);
  console.log('');
}

/**
 * Fun√ß√£o para usar MongoDB como auth state
 */
async function useMongoDBAuthState(collection) {
  // L√™ as credenciais do MongoDB
  const readCreds = async () => {
    const data = await collection.findOne({ _id: 'creds' });
    return data ? JSON.parse(JSON.stringify(data.value), BufferJSON.reviver) : null;
  };

  // L√™ uma chave espec√≠fica
  const readKey = async (id) => {
    const data = await collection.findOne({ _id: id });
    return data ? JSON.parse(JSON.stringify(data.value), BufferJSON.reviver) : null;
  };

  // Escreve dados no MongoDB
  const writeData = async (id, value) => {
    const data = JSON.parse(JSON.stringify(value, BufferJSON.replacer));
    await collection.updateOne(
      { _id: id },
      { $set: { value: data } },
      { upsert: true }
    );
  };

  // Remove dados do MongoDB
  const removeData = async (id) => {
    await collection.deleteOne({ _id: id });
  };

  // Carrega credenciais existentes ou cria novas
  let creds = await readCreds();
  if (!creds) {
    creds = initAuthCreds();
    await writeData('creds', creds);
  }

  return {
    state: {
      creds,
      keys: {
        get: async (type, ids) => {
          const data = {};
          for (const id of ids) {
            let value = await readKey(`${type}-${id}`);
            if (value) {
              data[id] = value;
            }
          }
          return data;
        },
        set: async (data) => {
          for (const category in data) {
            for (const id in data[category]) {
              const value = data[category][id];
              const key = `${category}-${id}`;
              if (value) {
                await writeData(key, value);
              } else {
                await removeData(key);
              }
            }
          }
        }
      }
    },
    saveCreds: async () => {
      await writeData('creds', creds);
    },
    clearAll: async () => {
      await collection.deleteMany({});
    }
  };
}

/**
 * INICIALIZA O BOT
 */
async function startBot() {
  showBanner();
  
  // Inicia servidor HTTP se estiver no Render
  if (process.env.RENDER) {
    console.log('üîß Ambiente Render detectado - iniciando servidor HTTP...');
    startServer();
    keepAlive();
  }
  
  // Valida configura√ß√£o da Groq
  if (!validateGroqConfig()) {
    console.error('\n‚ùå Configure a API Key da Groq no arquivo .env antes de continuar!\n');
    process.exit(1);
  }
  
  // Valida MONGODB_URI
  if (!MONGODB_URI) {
    console.error('\n‚ùå Configure MONGODB_URI no arquivo .env antes de continuar!\n');
    process.exit(1);
  }
  
  log('INFO', 'üîÑ Iniciando conex√£o com WhatsApp...');
  
  let mongoClient;
  
  try {
    // Obt√©m vers√£o mais recente do Baileys
    const { version, isLatest } = await fetchLatestBaileysVersion();
    log('SUCCESS', `‚úÖ Baileys v${version.join('.')} ${isLatest ? '(latest)' : '(outdated)'}`);
    
    // Conecta ao MongoDB
    log('INFO', 'üîó Conectando ao MongoDB...');
    mongoClient = new MongoClient(MONGODB_URI);
    await mongoClient.connect();
    
    const db = mongoClient.db('baileys_auth');
    const collection = db.collection(SESSION_ID);
    
    log('SUCCESS', '‚úÖ MongoDB conectado com sucesso!');
    
    // Usa MongoDB para auth state
    const { state, saveCreds, clearAll } = await useMongoDBAuthState(collection);
    
    // Cria socket de conex√£o
    const sock = makeWASocket({
      version,
      logger: pino({ level: 'silent' }),
      printQRInTerminal: false,
      auth: state,
      browser: ['Stream Studio Bot', 'Chrome', '1.0.0'],
      markOnlineOnConnect: true
    });
    
    // ============================================
    // EVENTO: Atualiza√ß√£o de credenciais
    // ============================================
    sock.ev.on('creds.update', saveCreds);
    
    // ============================================
    // EVENTO: Atualiza√ß√£o de conex√£o
    // ============================================
    sock.ev.on('connection.update', async (update) => {
      const { connection, lastDisconnect, qr } = update;
      
      // Mostra QR Code
      if (qr) {
        console.log('\nüì± ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üì± ESCANEIE O QR CODE ABAIXO COM SEU WHATSAPP BUSINESS');
        console.log('üì± ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        qrcode.generate(qr, { small: true });
        console.log('\nüì± ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
      }
      
      // Conex√£o fechada
      if (connection === 'close') {
        const shouldReconnect = (lastDisconnect?.error instanceof Boom) 
          ? lastDisconnect.error.output.statusCode !== DisconnectReason.loggedOut
          : true;
        
        if (shouldReconnect) {
          log('WARNING', '‚ö†Ô∏è  Conex√£o perdida. Reconectando...');
          setTimeout(() => startBot(), 3000);
        } else {
          log('ERROR', '‚ùå Desconectado. Limpando credenciais...');
          await clearAll();
          await mongoClient.close();
          process.exit(0);
        }
      }
      
      // Conectado
      if (connection === 'open') {
        log('SUCCESS', '‚úÖ Conectado ao WhatsApp com sucesso!');
        console.log('\nüéâ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üéâ BOT ONLINE E FUNCIONANDO!');
        console.log('üéâ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        
        // Mostra estat√≠sticas
        printStats();
        
        // Instru√ß√µes
        console.log('üìã COMANDOS DISPON√çVEIS (envie para o cliente):');
        console.log(`   ‚Ä¢ ${process.env.COMMAND_ASSUME} - Assumir atendimento manual`);
        console.log(`   ‚Ä¢ ${process.env.COMMAND_RELEASE} - Liberar bot autom√°tico`);
        console.log('\nüí° DICA: Ao enviar qualquer mensagem para um cliente,');
        console.log('   o bot automaticamente para de responder (atendimento manual).\n');
        
        console.log('üîç COMANDOS NO CONSOLE:');
        console.log('   Digite "stats" para ver estat√≠sticas');
        console.log('   Digite "blocked" para ver usu√°rios em atendimento manual');
        console.log('   Digite "users" para ver todos os usu√°rios\n');
      }
    });
    
    // ============================================
    // EVENTO: Novas mensagens
    // ============================================
    sock.ev.on('messages.upsert', async ({ messages, type }) => {
      if (type !== 'notify') return;
      
      for (const message of messages) {
        try {
          // Ignora mensagens pr√≥prias
          if (message.key.fromMe) {
            // Processa comandos e auto-bloqueio do Roberto
            const isCommand = await handleCommand(sock, message);
            
            if (!isCommand) {
              // Se n√£o √© comando, verifica auto-bloqueio
              await handleOwnerMessage(sock, message);
            }
            
            continue;
          }
          
          // Processa mensagem recebida
          await processMessage(sock, message);
          
        } catch (error) {
          log('ERROR', `‚ùå Erro ao processar mensagem: ${error.message}`);
          console.error(error);
        }
      }
    });
    
    // ============================================
    // EVENTO: Presen√ßa (status online/offline)
    // ============================================
    sock.ev.on('presence.update', ({ id, presences }) => {
      if (process.env.DEBUG_MODE === 'true') {
        log('INFO', `üëÅÔ∏è  Presen√ßa atualizada: ${id}`);
      }
    });
    
    // ============================================
    // COMANDOS NO CONSOLE
    // ============================================
    setupConsoleCommands();
    
    return sock;
    
  } catch (error) {
    log('ERROR', `‚ùå Erro ao iniciar bot: ${error.message}`);
    console.error(error);
    if (mongoClient) {
      await mongoClient.close();
    }
    process.exit(1);
  }
}

/**
 * Configura comandos interativos no console
 */
function setupConsoleCommands() {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
    prompt: ''
  });
  
  rl.on('line', (input) => {
    const command = input.trim().toLowerCase();
    
    switch (command) {
      case 'stats':
        showStats();
        break;
        
      case 'blocked':
        listBlockedUsers();
        break;
        
      case 'users':
        listAllUsers();
        break;
        
      case 'help':
        console.log('\nüìã COMANDOS DISPON√çVEIS:');
        console.log('   stats   - Mostra estat√≠sticas do bot');
        console.log('   blocked - Lista usu√°rios em atendimento manual');
        console.log('   users   - Lista todos os usu√°rios cadastrados');
        console.log('   help    - Mostra esta ajuda');
        console.log('   clear   - Limpa o console\n');
        break;
        
      case 'clear':
        console.clear();
        showBanner();
        break;
        
      default:
        if (command) {
          console.log(`‚ùå Comando "${command}" n√£o reconhecido. Digite "help" para ajuda.\n`);
        }
    }
  });
}

/**
 * Tratamento de erros n√£o capturados
 */
process.on('unhandledRejection', (err) => {
  log('ERROR', `‚ùå Unhandled Rejection: ${err.message}`);
  console.error(err);
});

process.on('uncaughtException', (err) => {
  log('ERROR', `‚ùå Uncaught Exception: ${err.message}`);
  console.error(err);
  process.exit(1);
});

/**
 * Tratamento de encerramento gracioso
 */
process.on('SIGINT', () => {
  console.log('\n\nüëã Encerrando bot...');
  log('INFO', 'üõë Bot encerrado pelo usu√°rio');
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\n\nüëã Encerrando bot...');
  log('INFO', 'üõë Bot encerrado');
  process.exit(0);
});

/**
 * INICIA O BOT
 */
startBot();